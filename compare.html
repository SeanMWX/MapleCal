<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MapleCal 双栏对比</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;600&family=Space+Grotesk:wght@400;600&display=swap");

      :root {
        --bg: #f4efe7;
        --bg-2: #f0e3d1;
        --ink: #1c1b1a;
        --muted: #6b655c;
        --accent: #c94f2d;
        --accent-2: #2a6f6a;
        --card: #fff7ed;
        --ring: rgba(201, 79, 45, 0.2);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        color: var(--ink);
        font-family: "Noto Sans SC", "Space Grotesk", sans-serif;
        background:
          radial-gradient(900px 500px at 10% -10%, #ffe8c7 0, transparent 60%),
          radial-gradient(700px 400px at 110% 10%, #d9f1ef 0, transparent 60%),
          linear-gradient(180deg, var(--bg), var(--bg-2));
        min-height: 100vh;
      }

      .wrap {
        max-width: 1200px;
        margin: 0 auto;
        padding: 32px 20px 60px;
      }

      header {
        display: grid;
        gap: 12px;
        margin-bottom: 24px;
        animation: fadeIn 450ms ease both;
      }

      h1 {
        font-family: "Space Grotesk", "Noto Sans SC", sans-serif;
        font-size: clamp(28px, 4vw, 42px);
        margin: 0;
        letter-spacing: 0.5px;
      }

      header p {
        margin: 0;
        color: var(--muted);
      }

      a {
        color: var(--accent);
        text-decoration: none;
      }

      .grid {
        display: grid;
        gap: 16px;
      }

      .grid-2 {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }

      .grid-3 {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      .card {
        background: var(--card);
        border: 1px solid rgba(0, 0, 0, 0.06);
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
      }

      .card h2 {
        margin: 0 0 12px;
        font-size: 18px;
      }

      label {
        display: grid;
        gap: 6px;
        font-size: 14px;
        color: var(--muted);
      }

      input[type="number"] {
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid rgba(0, 0, 0, 0.12);
        background: #fff;
        font-size: 15px;
        outline: none;
        transition: box-shadow 150ms ease, border-color 150ms ease;
      }

      input[type="number"]:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 4px var(--ring);
      }

      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      button {
        border: none;
        border-radius: 999px;
        padding: 10px 18px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        color: #fff;
        background: var(--accent);
        transition: transform 120ms ease, box-shadow 120ms ease;
      }

      button.secondary {
        background: var(--accent-2);
      }

      button:active {
        transform: translateY(1px);
      }

      .result {
        font-family: "Space Grotesk", "Noto Sans SC", sans-serif;
        font-size: 22px;
        font-weight: 600;
      }

      .note {
        color: var(--muted);
        font-size: 13px;
      }

      .delta-item {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        padding: 8px 10px;
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.03);
        font-size: 14px;
      }

      .warning {
        color: #8c2c1a;
        font-size: 13px;
      }

      footer {
        margin-top: 24px;
        color: var(--muted);
        font-size: 12px;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <h1>双栏对比</h1>
        <p>左右两套配置对比输出差异。返回主页：<a href="/">MapleCal 计算器</a></p>
      </header>

      <div class="grid grid-2">
        <section class="card">
          <h2>当前配置 A</h2>
          <div class="grid grid-2" id="form-a"></div>
        </section>
        <section class="card">
          <h2>对比配置 B</h2>
          <div class="grid grid-2" id="form-b"></div>
        </section>
      </div>

      <div class="actions" style="margin-top: 12px">
        <button id="reset" class="secondary">重置为默认值</button>
      </div>
      <div id="warning" class="warning"></div>

      <div class="grid grid-3" style="margin-top: 16px">
        <section class="card">
          <h2>战斗力</h2>
          <div class="result" id="cp_a">-</div>
          <div class="note" id="cp_b">B: -</div>
          <div class="delta-item" id="cp_delta">差值：-</div>
        </section>
        <section class="card">
          <h2>面板</h2>
          <div class="result" id="panel_a">-</div>
          <div class="note" id="panel_b">B: -</div>
          <div class="delta-item" id="panel_delta">差值：-</div>
        </section>
        <section class="card">
          <h2>输出</h2>
          <div class="result" id="output_a">-</div>
          <div class="note" id="output_b">B: -</div>
          <div class="delta-item" id="output_delta">差值：-</div>
        </section>
      </div>

      <footer>
        提示：输出差异 = B - A，百分比基于 A。
      </footer>
    </div>

    <script>
      const fields = [
        { key: "main_base", label: "主属性基础值", value: 5635 },
        { key: "main_skill", label: "主属性技能", value: 448 },
        { key: "main_percent", label: "主属性% (输入百分比)", value: 523 },
        { key: "main_notper", label: "主属性非%加成", value: 27465 },
        { key: "sub_base", label: "副属性基础值", value: 2991 },
        { key: "sub_skill", label: "副属性技能", value: 144 },
        { key: "sub_percent", label: "副属性% (输入百分比)", value: 72 },
        { key: "sub_notper", label: "副属性非%加成", value: 540 },
        { key: "attack_base", label: "攻击力基础值", value: 3740 },
        { key: "attack_skill", label: "攻击力技能", value: 190 },
        { key: "empress_blessing", label: "皇后祝福", value: 30 },
        { key: "weapon_fix", label: "weapon_fix", value: -109 },
        { key: "attack_percet", label: "攻击力% (输入百分比)", value: 139 },
        { key: "attack_notper", label: "攻击力非%加成", value: 0 },
        { key: "dmg", label: "伤害% (输入百分比)", value: 141 },
        { key: "dmg_skill", label: "伤害技能% (输入百分比)", value: 70 },
        { key: "bossdmg", label: "Boss伤% (输入百分比)", value: 463 },
        { key: "bossdmg_skill", label: "Boss伤技能% (输入百分比)", value: 63 },
        { key: "cridmg", label: "暴伤% (输入百分比)", value: 112.6 },
        { key: "cridmg_skill", label: "暴伤技能% (输入百分比)", value: 17 },
        { key: "final_damage", label: "最终伤害% (输入百分比)", value: 54 },
        { key: "gwp_fd", label: "创世武器最终伤害% (gwp_fd)", value: 10 },
        { key: "mst_fd", label: "怪怪卡最终伤害% (mst_fd)", value: 0 },
        { key: "ign", label: "无视防御% (IGN，输入百分比)", value: 90 },
        { key: "p2", label: "全属性防御穿透% (P2，输入百分比)", value: 10 },
        { key: "boss_def", label: "Boss防御% (boss_def，输入百分比)", value: 300 }
      ];

      function renderForm(containerId, prefix, overrides = {}, readOnly = false) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        fields.forEach((field) => {
          const wrapper = document.createElement("label");
          wrapper.textContent = field.label;
          const input = document.createElement("input");
          input.type = "number";
          input.id = `${prefix}_${field.key}`;
          input.value = overrides[field.key] ?? field.value;
          input.step = "0.01";
          if (readOnly || (prefix === "b" && field.key === "boss_def")) {
            input.disabled = true;
            input.style.opacity = "0.6";
          }
          wrapper.appendChild(input);
          container.appendChild(wrapper);
        });
      }

      function readValues(prefix) {
        const values = {};
        fields.forEach((field) => {
          const input = document.getElementById(`${prefix}_${field.key}`);
          const raw = input.value;
          const value = parseFloat(raw);
          values[field.key] = Number.isFinite(value) ? value : 0;
        });
        values.delta_step = 1;
        return values;
      }

      function formatNumber(num) {
        return Number.isFinite(num) ? num.toLocaleString("en-US") : "-";
      }

      function setDelta(elId, a, b) {
        const delta = b - a;
        const percent = a === 0 ? 0 : (delta / a) * 100;
        const sign = delta >= 0 ? "+" : "";
        document.getElementById(elId).textContent = `差值：${sign}${formatNumber(delta)} (${sign}${percent.toFixed(2)}%)`;
      }

      async function fetchCalc(values) {
        const response = await fetch("/api/calc", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(values)
        });
        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.detail || "计算失败");
        }
        return data;
      }

      async function compare() {
        const warning = document.getElementById("warning");
        warning.textContent = "";
        try {
          const [a, b] = await Promise.all([
            fetchCalc(readValues("a")),
            fetchCalc(readValues("b"))
          ]);

          document.getElementById("cp_a").textContent = formatNumber(a.combat_power);
          document.getElementById("cp_b").textContent = `B: ${formatNumber(b.combat_power)}`;
          setDelta("cp_delta", a.combat_power || 0, b.combat_power || 0);

          document.getElementById("panel_a").textContent = formatNumber(a.panel);
          document.getElementById("panel_b").textContent = `B: ${formatNumber(b.panel)}`;
          setDelta("panel_delta", a.panel || 0, b.panel || 0);

          document.getElementById("output_a").textContent = formatNumber(a.damage_output);
          document.getElementById("output_b").textContent = `B: ${formatNumber(b.damage_output)}`;
          setDelta("output_delta", a.damage_output || 0, b.damage_output || 0);

          if (a.warning || b.warning) {
            warning.textContent = [a.warning, b.warning].filter(Boolean).join(" | ");
          }
        } catch (err) {
          warning.textContent = err.message || "对比失败";
        }
      }

      document.getElementById("reset").addEventListener("click", () => {
        renderForm("form-a", "a");
        renderForm("form-b", "b");
        localStorage.removeItem("maplecal_preset_b");
        compare();
      });

      document.addEventListener("input", (event) => {
        if (event.target && event.target.matches("input[type='number']")) {
          if (event.target.id && event.target.id.startsWith("b_")) {
            savePresetB(readValues("b"));
          }
          compare();
        }
      });

      function savePresetB(values) {
        localStorage.setItem("maplecal_preset_b", JSON.stringify(values));
      }

      function loadPreset(key) {
        const stored = localStorage.getItem(key);
        if (!stored) {
          return {};
        }
        try {
          return JSON.parse(stored);
        } catch {
          return {};
        }
      }

      const presetA = loadPreset("maplecal_preset");
      const presetB = loadPreset("maplecal_preset_b");
      renderForm("form-a", "a", presetA, true);
      renderForm("form-b", "b", Object.keys(presetB).length ? presetB : presetA, false);
      compare();
    </script>
  </body>
</html>
